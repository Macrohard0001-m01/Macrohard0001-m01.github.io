<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线曲库 - Macrohard Studio</title>
    <link rel="icon" href="https://github.com/Macrohard0001-m01/Macrohard0001-m01.github.io/blob/main/images/macrohard_icon_music_head.png?raw=true" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #e2e8f0;
            --border-color: #334155;
            --hover-color: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 导航栏 */
        header {
            background-color: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 8px;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .logo-icon img, .footer-logo-icon img {
            width: 100%;
            height: 100%;
            border-radius: inherit;
            object-fit: cover;
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            margin-left: 25px;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--primary-color);
        }

        .nav-right {
            display: flex;
            align-items: center;
        }

        .theme-toggle, .hamburger {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 15px;
        }

        /* 英雄区域 */
        .hero {
            background: linear-gradient(135deg, var(--primary-color), #6a11cb);
            padding: 80px 0;
            text-align: center;
            margin-bottom: 40px;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* 音乐库布局 */
        .music-library {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }

        .folders-panel {
            flex: 0 0 250px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
        }

        .songs-panel {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
        }

        .playlist-panel {
            flex: 0 0 300px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
        }

        .panel-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 文件夹列表 */
        .folder-list {
            list-style: none;
        }

        .folder-item {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }

        .folder-item:hover {
            background-color: var(--hover-color);
        }

        .folder-item.active {
            background-color: var(--primary-color);
        }

        .folder-icon {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* 歌曲列表 */
        .song-list {
            list-style: none;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .song-item:hover {
            background-color: var(--hover-color);
        }

        .song-item.playing {
            background-color: rgba(74, 108, 247, 0.2);
            border-left: 3px solid var(--primary-color);
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .song-artist {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .song-duration {
            color: #94a3b8;
            margin: 0 15px;
        }

        .song-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s;
        }

        .btn:hover {
            color: var(--primary-color);
        }

        /* 播放列表 */
        .playlist-items {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background-color 0.3s;
        }

        .playlist-item:hover {
            background-color: var(--hover-color);
        }

        .playlist-item .song-info {
            flex: 1;
        }

        .playlist-item .btn-remove {
            color: #f87171;
        }

        /* 播放器控制 */
        .player-controls {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            position: sticky;
            bottom: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }

        .current-song {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .current-song-info {
            flex: 1;
            margin-left: 15px;
        }

        .current-song-title {
            font-weight: 500;
            font-size: 1.1rem;
        }

        .current-song-artist {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .progress-container {
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 5px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .control-btn:hover {
            color: var(--primary-color);
        }

        .control-btn.play-pause {
            background-color: var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
        }

        /* 音量控制 */
        .volume-control {
            display: flex;
            align-items: center;
            position: relative;
        }

        .volume-slider-container {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 10;
        }

        .volume-control:hover .volume-slider-container {
            display: block;
        }

        .volume-slider {
            width: 100px;
            height: 5px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }

        /* 镜像选择器 */
        .mirror-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .mirror-selector select {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
        }

        /* 页脚 */
        footer {
            background-color: var(--card-bg);
            padding: 40px 0 20px;
            margin-top: 40px;
        }

        .footer-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .footer-column {
            flex: 1;
            min-width: 200px;
            margin-bottom: 20px;
        }

        .footer-logo {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .footer-logo-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            border-radius: 5px;
        }

        .footer-column h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .footer-column ul {
            list-style: none;
        }

        .footer-column ul li {
            margin-bottom: 10px;
        }

        .footer-column ul li a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-column ul li a:hover {
            color: var(--primary-color);
        }

        .footer-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            width: 70%;
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .music-library {
                flex-direction: column;
            }
            
            .folders-panel, .playlist-panel {
                flex: 1;
            }

            .footer-links {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .hero h1 {
                font-size: 2.2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }

            .footer-links {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="https://github.com/Macrohard0001-m01/Macrohard0001-m01.github.io/blob/main/images/macrohard_icon_music.png?raw=true" alt="Macrohard Music Logo">
                    </div>
                    <span>Macrohard Music</span>
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">返回首页</a></li>
                    <li><a href="music.html">返回音乐</a></li>
                    <li><a href="music-library.html" class="active">在线曲库</a></li>
                    <li><a href="about_music.html">关于</a></li>
                </ul>
                <div class="nav-right">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="hamburger">
                        <i class="fas fa-bars"></i>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- 英雄区域 -->
    <section class="hero">
        <div class="container">
            <h1>在线曲库</h1>
            <p>个人收藏，有啥听啥 | 分离式架构 | 多镜像加速</p>
        </div>
    </section>

    <!-- 音乐库内容 -->
    <div class="container">
        <div class="mirror-selector">
            <span>选择镜像站点:</span>
            <select id="mirrorSelect">
                <option value="default">默认站点</option>
                <option value="mirror1">镜像站点 1</option>
                <option value="mirror2">镜像站点 2</option>
            </select>
        </div>
        
        <div class="music-library">
            <!-- 文件夹面板 -->
            <div class="folders-panel">
                <div class="panel-title">
                    <span>音乐文件夹</span>
                    <button class="btn" title="刷新" id="refreshFolders">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <ul class="folder-list" id="folderList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>加载文件夹中...</p>
                    </div>
                </ul>
            </div>

            <!-- 歌曲面板 -->
            <div class="songs-panel">
                <div class="panel-title">
                    <span id="currentFolder">选择文件夹</span>
                    <div>
                        <button class="btn" title="播放全部" id="playAll">
                            <i class="fas fa-play-circle"></i>
                        </button>
                        <button class="btn" title="添加到播放列表" id="addAllToPlaylist">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                    </div>
                </div>
                <ul class="song-list" id="songList">
                    <div class="loading">
                        <i class="fas fa-music"></i>
                        <p>请选择一个文件夹</p>
                    </div>
                </ul>
            </div>

            <!-- 播放列表面板 -->
            <div class="playlist-panel">
                <div class="panel-title">
                    <span>播放列表</span>
                    <div>
                        <button class="btn" title="清空播放列表" id="clearPlaylist">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn" title="保存播放列表" id="savePlaylist">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </div>
                <div class="playlist-info">
                    <p>当前播放列表: <span id="currentPlaylistName">默认</span></p>
                </div>
                <ul class="playlist-items" id="playlistItems">
                    <div class="loading">
                        <p>播放列表为空</p>
                    </div>
                </ul>
                <div class="playlist-info">
                    <p>共 <span id="playlistCount">0</span> 首歌曲</p>
                </div>
            </div>
        </div>

        <!-- 播放器控制 -->
        <div class="player-controls">
            <div class="current-song">
                <div class="album-art">
                    <i class="fas fa-music" style="font-size: 2.5rem; color: #4a6cf7;"></i>
                </div>
                <div class="current-song-info">
                    <div class="current-song-title" id="currentSongTitle">选择一首歌曲开始播放</div>
                    <div class="current-song-artist" id="currentSongArtist">-</div>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            <div class="control-buttons">
                <button class="control-btn" title="上一首" id="prevBtn">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-pause" id="playPauseBtn">
                    <i class="fas fa-play" id="playPauseIcon"></i>
                </button>
                <button class="control-btn" title="下一首" id="nextBtn">
                    <i class="fas fa-step-forward"></i>
                </button>
                <div class="volume-control">
                    <button class="control-btn" title="音量" id="volumeBtn">
                        <i class="fas fa-volume-up" id="volumeIcon"></i>
                    </button>
                    <div class="volume-slider-container">
                        <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <div class="footer-logo">
                        <div class="footer-logo-icon">
                            <img src="https://github.com/Macrohard0001-m01/Macrohard0001-m01.github.io/blob/main/images/macrohard_icon_music.png?raw=true" alt="Macrohard Studio Logo">
                        </div>
                        Macrohard Studio
                    </div>
                    <p>高中生的小站</p>
                </div>
                
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>快速链接</h3>
                        <ul>
                            <li><a href="https://github.com/Macrohard0001-m01">个人主页</a></li>
                            <li><a href="https://github.com/Macrohard0001-m01" target="_blank">GitHub</a></li>
                            <li><a href="https://chat.deepseek.com/" target="_blank">DeepSeek</a></li>
                            <li><a href="https://docs.lxmusic.top/" target="_blank">LX Music</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-column">
                        <h3>作品</h3>
                        <ul>
                            <li><a href="software.html">AORE</a></li>
                            <li><a href="software.html">RCP3</a></li>
                            <li><a href="#">预留</a></li>
                            <li><a href="">预留</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-column">
                        <h3>联系信息</h3>
                        <ul>
                            <li><i class="fas fa-envelope"></i> Macrohard0001_m01@outlook.com</li>
                            <li><i class="fas fa-map-marker-alt"></i> hbzzzx</li>
                            <li><i class="fas fa-clock"></i> 我很忙~</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2025-2026 Macrohard Studio. 保留所有权利。 | 网站正在编写与测试，勿喷，勿催</p>
            </div>
        </div>
    </footer>

    <script>
        // 配置
        const CONFIG = {
            // 曲库数据URL
            libraryUrl: 'https://raw.githubusercontent.com/Macrohard0001-m01/Macrohard0001-m01.github.io/main/data/music-library.json',
            // 播放清单URL模板，{id}会被替换为播放清单ID
            playlistUrlTemplate: 'https://raw.githubusercontent.com/Macrohard0001-m01/Macrohard0001-m01.github.io/main/data/playlists/{id}.json',
            // 镜像站点配置
            mirrors: {
                default: {
                    name: '默认站点',
                    baseUrl: '/music/'
                },
                mirror1: {
                    name: '镜像站点 1',
                    baseUrl: 'https://cdn1.example.com/music/'
                },
                mirror2: {
                    name: '镜像站点 2',
                    baseUrl: 'https://cdn2.example.com/music/'
                }
            }
        };

        // 状态管理
        let state = {
            currentFolder: null,
            currentSong: null,
            isPlaying: false,
            playlist: [],
            currentTime: 0,
            duration: 0,
            volume: 1,
            audioElement: null,
            musicLibrary: null,
            currentPlaylistId: null,
            currentMirror: 'default'
        };

        // DOM 元素
        const folderList = document.getElementById('folderList');
        const songList = document.getElementById('songList');
        const playlistItems = document.getElementById('playlistItems');
        const currentFolder = document.getElementById('currentFolder');
        const playlistCount = document.getElementById('playlistCount');
        const currentPlaylistName = document.getElementById('currentPlaylistName');
        const currentSongTitle = document.getElementById('currentSongTitle');
        const currentSongArtist = document.getElementById('currentSongArtist');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTime = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const playAllBtn = document.getElementById('playAll');
        const addAllToPlaylistBtn = document.getElementById('addAllToPlaylist');
        const clearPlaylistBtn = document.getElementById('clearPlaylist');
        const savePlaylistBtn = document.getElementById('savePlaylist');
        const refreshFoldersBtn = document.getElementById('refreshFolders');
        const volumeBtn = document.getElementById('volumeBtn');
        const volumeIcon = document.getElementById('volumeIcon');
        const volumeSlider = document.getElementById('volumeSlider');
        const mirrorSelect = document.getElementById('mirrorSelect');

        // 初始化
        async function init() {
            // 从URL参数获取播放清单ID
            const urlParams = new URLSearchParams(window.location.search);
            const playlistId = urlParams.get('playlist');
            
            // 加载曲库数据
            await loadMusicLibrary();
            
            // 如果有播放清单参数，加载播放清单
            if (playlistId) {
                await loadPlaylist(playlistId);
            }
            
            updatePlaylistCount();
            
            // 创建音频元素
            state.audioElement = new Audio();
            setupAudioEvents();
            
            // 事件监听
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPrev);
            nextBtn.addEventListener('click', playNext);
            playAllBtn.addEventListener('click', playAll);
            addAllToPlaylistBtn.addEventListener('click', addAllToPlaylist);
            clearPlaylistBtn.addEventListener('click', clearPlaylist);
            savePlaylistBtn.addEventListener('click', savePlaylist);
            refreshFoldersBtn.addEventListener('click', refreshMusicData);
            progressBar.addEventListener('click', seek);
            volumeSlider.addEventListener('input', updateVolume);
            mirrorSelect.addEventListener('change', changeMirror);
            
            // 加载保存的播放列表
            loadSavedPlaylist();
        }

        // 加载曲库数据
        async function loadMusicLibrary() {
            try {
                const response = await fetch(CONFIG.libraryUrl);
                state.musicLibrary = await response.json();
                renderFolders();
            } catch (error) {
                console.error('加载曲库失败:', error);
                // 如果加载失败，使用内置的默认数据
                state.musicLibrary = getDefaultLibrary();
                renderFolders();
            }
        }

        // 加载播放清单
        async function loadPlaylist(playlistId) {
            try {
                const url = CONFIG.playlistUrlTemplate.replace('{id}', playlistId);
                const response = await fetch(url);
                const playlistData = await response.json();
                
                // 根据播放清单中的歌曲ID，从曲库中获取完整的歌曲信息
                state.playlist = playlistData.songs.map(songId => 
                    state.musicLibrary.songs.find(song => song.id === songId)
                ).filter(song => song); // 过滤掉未找到的歌曲
                
                state.currentPlaylistId = playlistId;
                currentPlaylistName.textContent = playlistData.name || playlistId;
                
                renderPlaylist();
                updatePlaylistCount();
                
                // 如果播放清单中有歌曲，自动播放第一首
                if (state.playlist.length > 0) {
                    playSong(state.playlist[0].id);
                }
            } catch (error) {
                console.error('加载播放清单失败:', error);
                alert(`无法加载播放清单: ${playlistId}`);
            }
        }

        // 更改镜像站点
        function changeMirror() {
            state.currentMirror = mirrorSelect.value;
            
            // 如果当前正在播放歌曲，重新加载当前歌曲
            if (state.currentSong) {
                const currentSongId = state.currentSong.id;
                playSong(currentSongId);
            }
        }

        // 获取歌曲的完整URL（根据当前镜像站点）
        function getSongUrl(songPath) {
            const mirror = CONFIG.mirrors[state.currentMirror];
            return mirror.baseUrl + songPath;
        }

        // 刷新音乐数据
        async function refreshMusicData() {
            folderList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>刷新中...</p></div>';
            try {
                await loadMusicLibrary();
                if (state.currentFolder) {
                    renderSongs();
                }
                alert('曲库已刷新');
            } catch (error) {
                console.error('刷新失败:', error);
                alert('刷新失败，使用缓存数据');
            }
        }

        // 设置音频事件
        function setupAudioEvents() {
            state.audioElement.addEventListener('loadedmetadata', () => {
                state.duration = state.audioElement.duration;
                durationEl.textContent = formatTime(state.duration);
            });

            state.audioElement.addEventListener('timeupdate', () => {
                state.currentTime = state.audioElement.currentTime;
                const progressPercent = (state.currentTime / state.duration) * 100;
                progress.style.width = `${progressPercent}%`;
                currentTime.textContent = formatTime(state.currentTime);
            });

            state.audioElement.addEventListener('ended', () => {
                playNext();
            });
        }

        // 渲染文件夹
        function renderFolders() {
            folderList.innerHTML = '';
            
            // 添加"所有歌曲"选项
            const allSongsItem = document.createElement('li');
            allSongsItem.className = 'folder-item active';
            allSongsItem.innerHTML = `
                <i class="fas fa-folder-open folder-icon"></i>
                <span>所有歌曲</span>
                <span style="margin-left: auto; font-size: 0.8rem; color: #94a3b8;">${state.musicLibrary.songs.length}</span>
            `;
            allSongsItem.addEventListener('click', () => {
                document.querySelectorAll('.folder-item').forEach(item => item.classList.remove('active'));
                allSongsItem.classList.add('active');
                state.currentFolder = null;
                currentFolder.textContent = '所有歌曲';
                renderSongs();
            });
            folderList.appendChild(allSongsItem);
            
            // 添加各个文件夹
            state.musicLibrary.folders.forEach(folder => {
                const folderItem = document.createElement('li');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <i class="fas fa-folder folder-icon"></i>
                    <span>${folder.name}</span>
                    <span style="margin-left: auto; font-size: 0.8rem; color: #94a3b8;">${folder.count}</span>
                `;
                folderItem.addEventListener('click', () => {
                    document.querySelectorAll('.folder-item').forEach(item => item.classList.remove('active'));
                    folderItem.classList.add('active');
                    state.currentFolder = folder.id;
                    currentFolder.textContent = folder.name;
                    renderSongs();
                });
                folderList.appendChild(folderItem);
            });
        }

        // 渲染歌曲列表
        function renderSongs() {
            songList.innerHTML = '';
            
            let songsToShow = state.currentFolder 
                ? state.musicLibrary.songs.filter(song => song.folderId === state.currentFolder)
                : state.musicLibrary.songs;
                
            if (songsToShow.length === 0) {
                songList.innerHTML = '<div class="loading"><p>该文件夹中没有歌曲</p></div>';
                return;
            }
                
            songsToShow.forEach(song => {
                const songItem = document.createElement('li');
                songItem.className = 'song-item';
                if (state.currentSong && state.currentSong.id === song.id) {
                    songItem.classList.add('playing');
                }
                
                songItem.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                    <div class="song-duration">${song.duration}</div>
                    <div class="song-actions">
                        <button class="btn play-song" data-id="${song.id}" title="播放">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn add-to-playlist" data-id="${song.id}" title="添加到播放列表">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                
                songList.appendChild(songItem);
            });
            
            // 添加歌曲事件监听
            document.querySelectorAll('.play-song').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const songId = parseInt(e.currentTarget.getAttribute('data-id'));
                    playSong(songId);
                });
            });
            
            document.querySelectorAll('.add-to-playlist').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const songId = parseInt(e.currentTarget.getAttribute('data-id'));
                    addToPlaylist(songId);
                });
            });
        }

        // 播放歌曲
        function playSong(songId) {
            const song = state.musicLibrary.songs.find(s => s.id === songId);
            if (!song) return;
            
            state.currentSong = song;
            state.isPlaying = true;
            
            // 设置音频源（使用当前镜像站点）
            const songUrl = getSongUrl(song.url);
            state.audioElement.src = songUrl;
            state.audioElement.volume = state.volume;
            state.audioElement.play().catch(error => {
                console.error('播放失败:', error);
                alert('播放失败，请检查音乐文件路径或网络连接');
            });
            
            currentSongTitle.textContent = song.title;
            currentSongArtist.textContent = song.artist;
            playPauseIcon.className = 'fas fa-pause';
            
            // 更新UI
            document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing'));
            document.querySelectorAll('.song-item').forEach(item => {
                if (parseInt(item.querySelector('.play-song').getAttribute('data-id')) === songId) {
                    item.classList.add('playing');
                }
            });
        }

        // 添加到播放列表
        function addToPlaylist(songId) {
            const song = state.musicLibrary.songs.find(s => s.id === songId);
            if (!song) return;
            
            // 检查是否已在播放列表中
            if (state.playlist.some(s => s.id === songId)) {
                alert('这首歌已经在播放列表中了！');
                return;
            }
            
            state.playlist.push(song);
            renderPlaylist();
            updatePlaylistCount();
        }

        // 渲染播放列表
        function renderPlaylist() {
            playlistItems.innerHTML = '';
            
            if (state.playlist.length === 0) {
                playlistItems.innerHTML = '<div class="loading"><p>播放列表为空</p></div>';
                return;
            }
            
            state.playlist.forEach((song, index) => {
                const playlistItem = document.createElement('li');
                playlistItem.className = 'playlist-item';
                playlistItem.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                    </div>
                    <button class="btn btn-remove" data-index="${index}" title="从播放列表移除">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                playlistItems.appendChild(playlistItem);
            });
            
            // 添加移除事件监听
            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    removeFromPlaylist(index);
                });
            });
        }

        // 从播放列表移除
        function removeFromPlaylist(index) {
            state.playlist.splice(index, 1);
            renderPlaylist();
            updatePlaylistCount();
        }

        // 更新播放列表计数
        function updatePlaylistCount() {
            playlistCount.textContent = state.playlist.length;
        }

        // 播放/暂停切换
        function togglePlayPause() {
            if (!state.currentSong) {
                if (state.playlist.length > 0) {
                    playSong(state.playlist[0].id);
                } else if (state.musicLibrary.songs.length > 0) {
                    playSong(state.musicLibrary.songs[0].id);
                }
                return;
            }
            
            if (state.isPlaying) {
                state.audioElement.pause();
                playPauseIcon.className = 'fas fa-play';
            } else {
                state.audioElement.play();
                playPauseIcon.className = 'fas fa-pause';
            }
            state.isPlaying = !state.isPlaying;
        }

        // 播放上一首
        function playPrev() {
            if (!state.currentSong || state.playlist.length === 0) return;
            
            const currentIndex = state.playlist.findIndex(song => song.id === state.currentSong.id);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : state.playlist.length - 1;
            playSong(state.playlist[prevIndex].id);
        }

        // 播放下一首
        function playNext() {
            if (!state.currentSong || state.playlist.length === 0) return;
            
            const currentIndex = state.playlist.findIndex(song => song.id === state.currentSong.id);
            const nextIndex = currentIndex < state.playlist.length - 1 ? currentIndex + 1 : 0;
            playSong(state.playlist[nextIndex].id);
        }

        // 播放全部
        function playAll() {
            let songsToPlay = state.currentFolder 
                ? state.musicLibrary.songs.filter(song => song.folderId === state.currentFolder)
                : state.musicLibrary.songs;
                
            if (songsToPlay.length === 0) return;
            
            state.playlist = [...songsToPlay];
            renderPlaylist();
            updatePlaylistCount();
            playSong(songsToPlay[0].id);
        }

        // 添加全部到播放列表
        function addAllToPlaylist() {
            let songsToAdd = state.currentFolder 
                ? state.musicLibrary.songs.filter(song => song.folderId === state.currentFolder)
                : state.musicLibrary.songs;
                
            // 过滤掉已经在播放列表中的歌曲
            songsToAdd = songsToAdd.filter(song => !state.playlist.some(s => s.id === song.id));
            
            state.playlist.push(...songsToAdd);
            renderPlaylist();
            updatePlaylistCount();
            
            if (songsToAdd.length > 0) {
                alert(`已添加 ${songsToAdd.length} 首歌曲到播放列表`);
            } else {
                alert('所有歌曲已在播放列表中');
            }
        }

        // 清空播放列表
        function clearPlaylist() {
            if (state.playlist.length === 0) return;
            
            if (confirm('确定要清空播放列表吗？')) {
                state.playlist = [];
                renderPlaylist();
                updatePlaylistCount();
            }
        }

        // 保存播放列表
        function savePlaylist() {
            if (state.playlist.length === 0) {
                alert('播放列表为空，无法保存');
                return;
            }
            
            const playlistData = {
                name: `${currentFolder.textContent} - ${new Date().toLocaleDateString()}`,
                songs: state.playlist
            };
            
            localStorage.setItem('savedPlaylist', JSON.stringify(playlistData));
            alert('播放列表已保存到本地存储');
        }

        // 加载保存的播放列表
        function loadSavedPlaylist() {
            const savedPlaylist = localStorage.getItem('savedPlaylist');
            if (savedPlaylist) {
                try {
                    const playlistData = JSON.parse(savedPlaylist);
                    state.playlist = playlistData.songs;
                    renderPlaylist();
                    updatePlaylistCount();
                } catch (e) {
                    console.error('加载播放列表失败:', e);
                }
            }
        }

        // 跳转进度
        function seek(e) {
            if (!state.currentSong || !state.audioElement) return;
            
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            state.audioElement.currentTime = percent * state.duration;
        }

        // 更新音量
        function updateVolume() {
            state.volume = volumeSlider.value / 100;
            state.audioElement.volume = state.volume;
            
            // 更新音量图标
            if (state.volume === 0) {
                volumeIcon.className = 'fas fa-volume-mute';
            } else if (state.volume < 0.5) {
                volumeIcon.className = 'fas fa-volume-down';
            } else {
                volumeIcon.className = 'fas fa-volume-up';
            }
        }

        // 工具函数：将秒数格式化为时间字符串
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // 默认曲库数据（当外部加载失败时使用）
        function getDefaultLibrary() {
            return {
                folders: [
                    { id: '001', name: "20251031更新上架", count: 34 },
                    { id: '002', name: "其他音乐", count: 0 },
                ],
                songs: [
                    { id: 1, folderId: '001', title: "(It Goes Like) Nanana (Edit)", artist: "Peggy Gou", duration: "3:25", url: "001/Nanana.mp3" },
                    { id: 2, folderId: '001', title: "Padam Padam (Single Version)", artist: "Kylie Minogue", duration: "2:46", url: "001/Padam Padam.mp3" },
                    { id: 3, folderId: '001', title: "DNA (Loving You) [feat. Hannah Boleyn]", artist: "Billy Gillies、Hannah Boleyn", duration: "3:15", url: "001/DNA Loving You.mp3" },
                    { id: 4, folderId: '001', title: "Ignite", artist: "K-391、Alan Walker、Julie Bergan、胜利", duration: "3:30", url: "001/Ignite.mp3" },
                    { id: 5, folderId: '001', title: "Do It Like That", artist: "TOMORROW X TOGETHER、Jonas Brothers、Alan Walker", duration: "2:59", url: "001/Do It Like That.mp3" },
                    { id: 6, folderId: '001', title: "Wasted", artist: "Tiësto、Matthew Koma", duration: "3:10", url: "001/Wasted.mp3" },
                    { id: 7, folderId: '001', title: "The Motto", artist: "Tiësto、Ava Max", duration: "2:44", url: "001/The Motto.mp3" },
                    { id: 8, folderId: '001', title: "Tantalizing", artist: "Tiësto、Soaky Siren", duration: "2:48", url: "001/Tantalizing.mp3" },
                    { id: 9, folderId: '001', title: "Hot Honey", artist: "Tiësto、Alana Springsteen", duration: "2:53", url: "001/Hot Honey.mp3" },
                    { id: 10, folderId: '001', title: "Undecided (Explicit)", artist: "Chris Brown", duration: "3:27", url: "001/Undecided.mp3" },
                    { id: 11, folderId: '001', title: "You Got Me", artist: "Justin Caruso、Tiësto", duration: "3:12", url: "001/You Got Me.mp3" },
                    { id: 12, folderId: '001', title: "BOOM", artist: "Tiësto、Sevenn", duration: "2:50", url: "001/BOOM.mp3" },
                    { id: 13, folderId: '001', title: "We Don't Talk Anymore", artist: "Charlie Puth、Selena Gomez", duration: "3:37", url: "001/We Don't Talk Anymore.mp3" },
                    { id: 14, folderId: '001', title: "Seasons", artist: "Rival、Cadmium、Harley Bird", duration: "3:45", url: "001/Seasons.mp3" },
                    { id: 15, folderId: '001', title: "PPAP (Pen-Pineapple-Apple-Pen)", artist: "PIKO太郎", duration: "0:45", url: "001/PPAP.mp3" },
                    { id: 16, folderId: '001', title: "Never Going Home Tonight (feat. Madison Love)", artist: "David Guetta、Alesso、Madison Love", duration: "2:58", url: "001/Never Going Home Tonight.mp3" },
                    { id: 17, folderId: '001', title: "Sorry", artist: "Justin Bieber", duration: "3:20", url: "001/Sorry.mp3" },
                    { id: 18, folderId: '001', title: "Mmm Yeah", artist: "Austin Mahone、Pitbull", duration: "3:47", url: "001/Mmm Yeah.mp3" },
                    { id: 19, folderId: '001', title: "Cruel Summer", artist: "Taylor Swift", duration: "2:58", url: "001/Cruel Summer.mp3" },
                    { id: 20, folderId: '001', title: "Señorita", artist: "Shawn Mendes、Camila Cabello", duration: "3:10", url: "001/Señorita.mp3" },
                    { id: 21, folderId: '001', title: "Shake It Off", artist: "Taylor Swift", duration: "3:39", url: "001/Shake It Off.mp3" },
                    { id: 22, folderId: '001', title: "JOYRIDE (Explicit)", artist: "Kesha", duration: "3:04", url: "001/JOYRIDE.mp3" },
                    { id: 23, folderId: '001', title: "Call Me Maybe", artist: "Carly Rae Jepsen", duration: "3:13", url: "001/Call Me Maybe.mp3" },
                    { id: 24, folderId: '001', title: "I Don't Wanna Wait", artist: "David Guetta、OneRepublic", duration: "2:52", url: "001/I Don't Wanna Wait.mp3" },
                    { id: 25, folderId: '001', title: "Moonshine", artist: "Alan Walker、Elley Duhè", duration: "3:08", url: "001/Moonshine.mp3" },
                    { id: 26, folderId: '001', title: "念诗之王", artist: "小可儿", duration: "1:50", url: "001/念诗之王.mp3" },
                    { id: 27, folderId: '001', title: "Eye of the Tiger", artist: "Survivor", duration: "4:05", url: "001/Eye of the Tiger.mp3" },
                    { id: 28, folderId: '001', title: "Coming Home", artist: "Tiësto、Mesto", duration: "3:15", url: "001/Coming Home.mp3" },
                    { id: 29, folderId: '001', title: "Colors (Vicetone Remix)", artist: "Vicetone、Hardwell、Tiësto、Andreas Moe", duration: "3:22", url: "001/Colors.mp3" },
                    { id: 30, folderId: '001', title: "No Mercy", artist: "MOTi", duration: "2:50", url: "001/No Mercy.mp3" },
                    { id: 31, folderId: '001', title: "Red Lights (Extended Version)", artist: "Tiësto", duration: "5:12", url: "001/Red Lights.mp3" },
                    { id: 32, folderId: '001', title: "Tear It Down (From Hotel Transylvania 3)", artist: "Tiësto", duration: "3:08", url: "001/Tear It Down.mp3" },
                    { id: 33, folderId: '001', title: "Stay", artist: "MOTi、Alida", duration: "3:05", url: "001/Stay.mp3" },
                    { id: 34, folderId: '001', title: "Feels Like You", artist: "MOTi、Robert Falcon", duration: "2:58", url: "001/Feels Like You.mp3" }
                ]
            };
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
